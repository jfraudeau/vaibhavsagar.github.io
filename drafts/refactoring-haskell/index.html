<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Refactoring Haskell: A Case Study - Vaibhav Sagar</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-79891461-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../about/">About</a>
                <a href="../../talks/">Talks</a>
                <a href="../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Refactoring Haskell: A Case Study</h1>

            <div class="info">
    Posted on 28 February 2018
    
</div>
<div class="info">
    
        Tags: <a href="../../blog/tags/programming/">programming</a>, <a href="../../blog/tags/haskell/">haskell</a>
    
</div>

<p>Many people claim that <a href="https://twitter.com/search?q=haskell%20refactoring">refactoring Haskell is a joy</a>. I’ve certainly found this to be the case, but what does that mean in practice? I thought it might be useful to demonstrate by refactoring some of my own code.</p>
<p>The code we’re looking at today is an implementation of <a href="https://en.wikipedia.org/wiki/Tarjan%27s_strongly_connected_components_algorithm">Tarjan’s Strongly Connected Components algorithm</a> used to determine whether a given 2SAT problem is satisfiable or not, and was written to complete <a href="https://online.stanford.edu/course/algorithms-design-and-analysis-part-1">an online course</a> that is now offered in a different form. I’ve <a href="http://vaibhavsagar.com/blog/2017/06/10/dag-toolkit/">written about Tarjan’s algorithm previously</a> and it can be used to determine the satisfiability of a 2SAT problem by checking if any SCC contains both a variable and its negation. If it does, we have a contradiction and the problem is unsatisfiable, otherwise the problem is satisfiable.</p>
<p>The initial version of the code is as follows:</p>
<details>
<p><summary>Initial 2SAT.hs</summary></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Graph</span>      <span class="kw">as</span> <span class="dt">G</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">M</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Set</span>        <span class="kw">as</span> <span class="dt">S</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Array</span>      <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span>         <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (lookup)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Control.Monad.ST</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.STRef</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Control.Monad</span> (forM_, when)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Data.Maybe</span> (isJust, isNothing, fromJust)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="ot">tarjan ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">G.Graph</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">S.Set</span> <span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">tarjan n graph <span class="fu">=</span> runST <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">    index    <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    stack    <span class="ot">&lt;-</span> newSTRef []</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    stackSet <span class="ot">&lt;-</span> newSTRef S.empty</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    indices  <span class="ot">&lt;-</span> newSTRef M.empty</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    lowlinks <span class="ot">&lt;-</span> newSTRef M.empty</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">    output   <span class="ot">&lt;-</span> newSTRef (<span class="dt">Just</span> [])</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    forM_ (G.vertices graph) <span class="fu">$</span> \v <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">        vIndex <span class="ot">&lt;-</span> M.lookup v <span class="fu">&lt;$&gt;</span> readSTRef indices</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">        when (isNothing vIndex) <span class="fu">$</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">            strongConnect n v graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb1-29" data-line-number="29"></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    readSTRef output</a>
<a class="sourceLine" id="cb1-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1-32" data-line-number="32">strongConnect</a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="ot">    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34">    <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35">    <span class="ot">-&gt;</span> <span class="dt">G.Graph</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb1-38" data-line-number="38">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">S.Set</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb1-39" data-line-number="39">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">M.Map</span> <span class="dt">Int</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb1-40" data-line-number="40">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">M.Map</span> <span class="dt">Int</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">Maybe</span> [<span class="dt">S.Set</span> <span class="dt">Int</span>])</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">    <span class="ot">-&gt;</span> <span class="dt">ST</span>    s ()</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">strongConnect n v graph index stack stackSet indices lowlinks output <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44">    i <span class="ot">&lt;-</span> readSTRef index</a>
<a class="sourceLine" id="cb1-45" data-line-number="45">    insert v i indices</a>
<a class="sourceLine" id="cb1-46" data-line-number="46">    insert v i lowlinks</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">    modifySTRef' index (<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">    push stack stackSet v</a>
<a class="sourceLine" id="cb1-49" data-line-number="49"></a>
<a class="sourceLine" id="cb1-50" data-line-number="50">    forM_ (graph <span class="fu">A.!</span> v) <span class="fu">$</span> \w <span class="ot">-&gt;</span> lookup w indices <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51">        <span class="dt">Nothing</span>     <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52">            strongConnect n w graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb1-53" data-line-number="53">            vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> lookup v lowlinks</a>
<a class="sourceLine" id="cb1-54" data-line-number="54">            wLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> lookup w lowlinks</a>
<a class="sourceLine" id="cb1-55" data-line-number="55">            insert v (min vLowLink wLowLink) lowlinks</a>
<a class="sourceLine" id="cb1-56" data-line-number="56">        <span class="dt">Just</span> wIndex <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57">            wOnStack <span class="ot">&lt;-</span> S.member w <span class="fu">&lt;$&gt;</span> readSTRef stackSet</a>
<a class="sourceLine" id="cb1-58" data-line-number="58">            when wOnStack <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59">                vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> lookup v lowlinks</a>
<a class="sourceLine" id="cb1-60" data-line-number="60">                insert v (min vLowLink wIndex) lowlinks</a>
<a class="sourceLine" id="cb1-61" data-line-number="61"></a>
<a class="sourceLine" id="cb1-62" data-line-number="62">    vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> lookup v lowlinks</a>
<a class="sourceLine" id="cb1-63" data-line-number="63">    vIndex   <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> lookup v indices</a>
<a class="sourceLine" id="cb1-64" data-line-number="64">    when (vLowLink <span class="fu">==</span> vIndex) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-65" data-line-number="65">        scc <span class="ot">&lt;-</span> addSCC n v S.empty stack stackSet</a>
<a class="sourceLine" id="cb1-66" data-line-number="66">        modifySTRef' output <span class="fu">$</span> \sccs <span class="ot">-&gt;</span> (<span class="fu">:</span>) <span class="fu">&lt;$&gt;</span> scc <span class="fu">&lt;*&gt;</span> sccs</a>
<a class="sourceLine" id="cb1-67" data-line-number="67">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-68" data-line-number="68">        lookup value hashMap     <span class="fu">=</span> M.lookup value <span class="fu">&lt;$&gt;</span> readSTRef hashMap</a>
<a class="sourceLine" id="cb1-69" data-line-number="69">        insert key value hashMap <span class="fu">=</span> modifySTRef' hashMap (M.insert key value)</a>
<a class="sourceLine" id="cb1-70" data-line-number="70"></a>
<a class="sourceLine" id="cb1-71" data-line-number="71"><span class="ot">addSCC ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">S.Set</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">S.Set</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">ST</span> s (<span class="dt">Maybe</span> (<span class="dt">S.Set</span> <span class="dt">Int</span>))</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">addSCC n v scc stack stackSet <span class="fu">=</span> pop stack stackSet <span class="fu">&gt;&gt;=</span> \w <span class="ot">-&gt;</span> <span class="kw">if</span> ((other n w) <span class="ot">`S.member`</span> scc) <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-73" data-line-number="73">    <span class="kw">let</span> scc' <span class="fu">=</span> S.insert w scc</a>
<a class="sourceLine" id="cb1-74" data-line-number="74">    <span class="kw">in</span> <span class="kw">if</span> w <span class="fu">==</span> v <span class="kw">then</span> return (<span class="dt">Just</span> scc') <span class="kw">else</span> addSCC n v scc' stack stackSet</a>
<a class="sourceLine" id="cb1-75" data-line-number="75"></a>
<a class="sourceLine" id="cb1-76" data-line-number="76"><span class="ot">push ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">S.Set</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s ()</a>
<a class="sourceLine" id="cb1-77" data-line-number="77">push stack stackSet e <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-78" data-line-number="78">    modifySTRef' stack    (e<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb1-79" data-line-number="79">    modifySTRef' stackSet (S.insert e)</a>
<a class="sourceLine" id="cb1-80" data-line-number="80"></a>
<a class="sourceLine" id="cb1-81" data-line-number="81"><span class="ot">pop ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">S.Set</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">ST</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-82" data-line-number="82">pop stack stackSet <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-83" data-line-number="83">    e <span class="ot">&lt;-</span> head <span class="fu">&lt;$&gt;</span> readSTRef stack</a>
<a class="sourceLine" id="cb1-84" data-line-number="84">    modifySTRef' stack tail</a>
<a class="sourceLine" id="cb1-85" data-line-number="85">    modifySTRef' stackSet (S.delete e)</a>
<a class="sourceLine" id="cb1-86" data-line-number="86">    return e</a>
<a class="sourceLine" id="cb1-87" data-line-number="87"></a>
<a class="sourceLine" id="cb1-88" data-line-number="88">denormalise     <span class="fu">=</span> subtract</a>
<a class="sourceLine" id="cb1-89" data-line-number="89">normalise       <span class="fu">=</span> (<span class="fu">+</span>)</a>
<a class="sourceLine" id="cb1-90" data-line-number="90">other n v       <span class="fu">=</span> <span class="dv">2</span><span class="fu">*</span>n <span class="fu">-</span> v</a>
<a class="sourceLine" id="cb1-91" data-line-number="91">clauses n [u,v] <span class="fu">=</span> [(other n u, v), (other n v, u)]</a>
<a class="sourceLine" id="cb1-92" data-line-number="92"></a>
<a class="sourceLine" id="cb1-93" data-line-number="93"><span class="ot">checkSat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-94" data-line-number="94">checkSat name <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-95" data-line-number="95">    p <span class="ot">&lt;-</span> map (map P.read <span class="fu">.</span> words) <span class="fu">.</span> lines <span class="fu">&lt;$&gt;</span> readFile name</a>
<a class="sourceLine" id="cb1-96" data-line-number="96">    <span class="kw">let</span> pNo    <span class="fu">=</span> head <span class="fu">$</span> head p</a>
<a class="sourceLine" id="cb1-97" data-line-number="97">        pn     <span class="fu">=</span> map (map (normalise pNo)) <span class="fu">$</span> tail p</a>
<a class="sourceLine" id="cb1-98" data-line-number="98">        pGraph <span class="fu">=</span> G.buildG (<span class="dv">0</span>,<span class="dv">2</span><span class="fu">*</span>pNo) <span class="fu">$</span> concatMap (clauses pNo) pn</a>
<a class="sourceLine" id="cb1-99" data-line-number="99">    return <span class="fu">$</span> (<span class="dt">Nothing</span> <span class="fu">/=</span>) <span class="fu">$</span> tarjan pNo pGraph</a></code></pre></div>
</details>
<p>I’ve included 2SAT-specific functionality for completeness, but I’ll only be changing the <code>tarjan</code> function and the functions it depends on (<code>strongConnect</code>, <code>addSCC</code>, <code>push</code>, and <code>pop</code>).</p>
<p>The first change is using more suitable data structures. Tarjan’s algorithm is only linear in the size of the graph when operations such as checking if <code>w</code> is on the stack and looking up indices happen in constant time (<span class="math inline"><em>O</em>(1)</span>). I’m currently using <code>Data.Map</code> and <code>Data.Set</code> which are both implemented with trees and are <span class="math inline"><em>O</em>(log <em>n</em>)</span> in these operations. A better choice would be <a href="http://hackage.haskell.org/package/vector/docs/Data-Vector-Mutable.html"><code>Data.Vector.Mutable</code></a> from the <code>vector</code> package, which does have constant-time operations.</p>
<details>
<p><summary>2SAT.hs using <code>vector</code></summary></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Graph</span> <span class="kw">as</span> <span class="dt">G</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Array</span> <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span>    <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (lookup, read, replicate)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Monad.ST</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.STRef</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Control.Monad</span>       (forM_, when)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Maybe</span>          (isJust, isNothing, fromJust)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Data.Vector.Mutable</span> (<span class="dt">STVector</span>, read, replicate, write)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="ot">tarjan ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">G.Graph</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [[<span class="dt">Int</span>]]</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">tarjan n graph <span class="fu">=</span> runST <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">    index    <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    stack    <span class="ot">&lt;-</span> newSTRef []</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    stackSet <span class="ot">&lt;-</span> replicate size <span class="dt">False</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">    indices  <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    lowlinks <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">    output   <span class="ot">&lt;-</span> newSTRef (<span class="dt">Just</span> [])</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    forM_ (G.vertices graph) <span class="fu">$</span> \v <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">        vIndex <span class="ot">&lt;-</span> read indices v</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">        when (isNothing vIndex) <span class="fu">$</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">            strongConnect n v graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    readSTRef output</a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">        size <span class="fu">=</span> snd (A.bounds graph) <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">strongConnect</a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="ot">    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35">    <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">    <span class="ot">-&gt;</span> <span class="dt">G.Graph</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">Maybe</span> [[<span class="dt">Int</span>]])</a>
<a class="sourceLine" id="cb2-43" data-line-number="43">    <span class="ot">-&gt;</span> <span class="dt">ST</span>    s ()</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">strongConnect n v graph index stack stackSet indices lowlinks output <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45">    i <span class="ot">&lt;-</span> readSTRef index</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">    write indices  v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb2-47" data-line-number="47">    write lowlinks v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">    modifySTRef' index (<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    push stack stackSet v</a>
<a class="sourceLine" id="cb2-50" data-line-number="50"></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">    forM_ (graph <span class="fu">A.!</span> v) <span class="fu">$</span> \w <span class="ot">-&gt;</span> read indices w <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb2-52" data-line-number="52">        <span class="dt">Nothing</span>     <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">            strongConnect n w graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">            vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read lowlinks v</a>
<a class="sourceLine" id="cb2-55" data-line-number="55">            wLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read lowlinks w</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">            write lowlinks v (<span class="dt">Just</span> (min vLowLink wLowLink))</a>
<a class="sourceLine" id="cb2-57" data-line-number="57">        <span class="dt">Just</span> wIndex <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-58" data-line-number="58">            wOnStack <span class="ot">&lt;-</span> read stackSet w</a>
<a class="sourceLine" id="cb2-59" data-line-number="59">            when wOnStack <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60">                vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read lowlinks v</a>
<a class="sourceLine" id="cb2-61" data-line-number="61">                write lowlinks v (<span class="dt">Just</span> (min vLowLink wIndex))</a>
<a class="sourceLine" id="cb2-62" data-line-number="62"></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">    vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read lowlinks v</a>
<a class="sourceLine" id="cb2-64" data-line-number="64">    vIndex   <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read indices  v</a>
<a class="sourceLine" id="cb2-65" data-line-number="65">    when (vLowLink <span class="fu">==</span> vIndex) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-66" data-line-number="66">        scc <span class="ot">&lt;-</span> addSCC n v [] stack stackSet</a>
<a class="sourceLine" id="cb2-67" data-line-number="67">        modifySTRef' output <span class="fu">$</span> \sccs <span class="ot">-&gt;</span> (<span class="fu">:</span>) <span class="fu">&lt;$&gt;</span> scc <span class="fu">&lt;*&gt;</span> sccs</a>
<a class="sourceLine" id="cb2-68" data-line-number="68"></a>
<a class="sourceLine" id="cb2-69" data-line-number="69"><span class="ot">addSCC ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s (<span class="dt">Maybe</span> [<span class="dt">Int</span>])</a>
<a class="sourceLine" id="cb2-70" data-line-number="70">addSCC n v scc stack stackSet <span class="fu">=</span> pop stack stackSet <span class="fu">&gt;&gt;=</span> \w <span class="ot">-&gt;</span> <span class="kw">if</span> ((other n w) <span class="ot">`elem`</span> scc) <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-71" data-line-number="71">    <span class="kw">let</span> scc' <span class="fu">=</span> w<span class="fu">:</span>scc</a>
<a class="sourceLine" id="cb2-72" data-line-number="72">    <span class="kw">in</span> <span class="kw">if</span> w <span class="fu">==</span> v <span class="kw">then</span> return (<span class="dt">Just</span> scc') <span class="kw">else</span> addSCC n v scc' stack stackSet</a>
<a class="sourceLine" id="cb2-73" data-line-number="73"></a>
<a class="sourceLine" id="cb2-74" data-line-number="74"><span class="ot">push ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s ()</a>
<a class="sourceLine" id="cb2-75" data-line-number="75">push stack stackSet e <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-76" data-line-number="76">    modifySTRef' stack (e<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb2-77" data-line-number="77">    write stackSet e <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-78" data-line-number="78"></a>
<a class="sourceLine" id="cb2-79" data-line-number="79"><span class="ot">pop ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-80" data-line-number="80">pop stack stackSet <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-81" data-line-number="81">    e <span class="ot">&lt;-</span> head <span class="fu">&lt;$&gt;</span> readSTRef stack</a>
<a class="sourceLine" id="cb2-82" data-line-number="82">    modifySTRef' stack tail</a>
<a class="sourceLine" id="cb2-83" data-line-number="83">    write stackSet e <span class="dt">False</span></a>
<a class="sourceLine" id="cb2-84" data-line-number="84">    return e</a>
<a class="sourceLine" id="cb2-85" data-line-number="85"></a>
<a class="sourceLine" id="cb2-86" data-line-number="86">denormalise     <span class="fu">=</span> subtract</a>
<a class="sourceLine" id="cb2-87" data-line-number="87">normalise       <span class="fu">=</span> (<span class="fu">+</span>)</a>
<a class="sourceLine" id="cb2-88" data-line-number="88">other n v       <span class="fu">=</span> <span class="dv">2</span><span class="fu">*</span>n <span class="fu">-</span> v</a>
<a class="sourceLine" id="cb2-89" data-line-number="89">clauses n [u,v] <span class="fu">=</span> [(other n u, v), (other n v, u)]</a>
<a class="sourceLine" id="cb2-90" data-line-number="90"></a>
<a class="sourceLine" id="cb2-91" data-line-number="91"><span class="ot">checkSat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb2-92" data-line-number="92">checkSat name <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-93" data-line-number="93">    p <span class="ot">&lt;-</span> map (map P.read <span class="fu">.</span> words) <span class="fu">.</span> lines <span class="fu">&lt;$&gt;</span> readFile name</a>
<a class="sourceLine" id="cb2-94" data-line-number="94">    <span class="kw">let</span> pNo    <span class="fu">=</span> head <span class="fu">$</span> head p</a>
<a class="sourceLine" id="cb2-95" data-line-number="95">        pn     <span class="fu">=</span> map (map (normalise pNo)) <span class="fu">$</span> tail p</a>
<a class="sourceLine" id="cb2-96" data-line-number="96">        pGraph <span class="fu">=</span> G.buildG (<span class="dv">0</span>,<span class="dv">2</span><span class="fu">*</span>pNo) <span class="fu">$</span> concatMap (clauses pNo) pn</a>
<a class="sourceLine" id="cb2-97" data-line-number="97">    return <span class="fu">$</span> (<span class="dt">Nothing</span> <span class="fu">/=</span>) <span class="fu">$</span> tarjan pNo pGraph</a></code></pre></div>
</details>
<details>
<p><summary>2SAT.hs using <code>(&lt;*&gt;)</code></summary></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Graph</span> <span class="kw">as</span> <span class="dt">G</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Array</span> <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span>    <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (lookup, read, replicate)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Monad.ST</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.STRef</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Control.Monad</span>       (forM_, when)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Maybe</span>          (isJust, isNothing, fromJust)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Data.Vector.Mutable</span> (<span class="dt">STVector</span>, read, replicate, write)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="ot">tarjan ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">G.Graph</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [[<span class="dt">Int</span>]]</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">tarjan n graph <span class="fu">=</span> runST <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">    index    <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">    stack    <span class="ot">&lt;-</span> newSTRef []</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    stackSet <span class="ot">&lt;-</span> replicate size <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">    indices  <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">    lowlinks <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">    output   <span class="ot">&lt;-</span> newSTRef (<span class="dt">Just</span> [])</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">    forM_ (G.vertices graph) <span class="fu">$</span> \v <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">        vIndex <span class="ot">&lt;-</span> read indices v</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">        when (isNothing vIndex) <span class="fu">$</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">            strongConnect n v graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb3-28" data-line-number="28"></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">    readSTRef output</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">        size <span class="fu">=</span> snd (A.bounds graph) <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"></a>
<a class="sourceLine" id="cb3-33" data-line-number="33">strongConnect</a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="ot">    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35">    <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36">    <span class="ot">-&gt;</span> <span class="dt">G.Graph</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">Maybe</span> [[<span class="dt">Int</span>]])</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">    <span class="ot">-&gt;</span> <span class="dt">ST</span>    s ()</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">strongConnect n v graph index stack stackSet indices lowlinks output <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45">    i <span class="ot">&lt;-</span> readSTRef index</a>
<a class="sourceLine" id="cb3-46" data-line-number="46">    write indices  v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb3-47" data-line-number="47">    write lowlinks v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48">    modifySTRef' index (<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-49" data-line-number="49">    push stack stackSet v</a>
<a class="sourceLine" id="cb3-50" data-line-number="50"></a>
<a class="sourceLine" id="cb3-51" data-line-number="51">    forM_ (graph <span class="fu">A.!</span> v) <span class="fu">$</span> \w <span class="ot">-&gt;</span> read indices w <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-53" data-line-number="53">            strongConnect n w graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb3-54" data-line-number="54">            write lowlinks v <span class="fu">=&lt;&lt;</span> (min <span class="fu">&lt;$&gt;</span> read lowlinks v <span class="fu">&lt;*&gt;</span> read lowlinks w)</a>
<a class="sourceLine" id="cb3-55" data-line-number="55">        <span class="dt">Just</span>{}  <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56">            wOnStack <span class="ot">&lt;-</span> read stackSet w</a>
<a class="sourceLine" id="cb3-57" data-line-number="57">            when wOnStack <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-58" data-line-number="58">                write lowlinks v <span class="fu">=&lt;&lt;</span> (min <span class="fu">&lt;$&gt;</span> read lowlinks v <span class="fu">&lt;*&gt;</span> read indices w)</a>
<a class="sourceLine" id="cb3-59" data-line-number="59"></a>
<a class="sourceLine" id="cb3-60" data-line-number="60">    vLowLink <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read lowlinks v</a>
<a class="sourceLine" id="cb3-61" data-line-number="61">    vIndex   <span class="ot">&lt;-</span> fromJust <span class="fu">&lt;$&gt;</span> read indices  v</a>
<a class="sourceLine" id="cb3-62" data-line-number="62">    when (vLowLink <span class="fu">==</span> vIndex) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-63" data-line-number="63">        scc <span class="ot">&lt;-</span> addSCC n v [] stack stackSet</a>
<a class="sourceLine" id="cb3-64" data-line-number="64">        modifySTRef' output <span class="fu">$</span> \sccs <span class="ot">-&gt;</span> (<span class="fu">:</span>) <span class="fu">&lt;$&gt;</span> scc <span class="fu">&lt;*&gt;</span> sccs</a>
<a class="sourceLine" id="cb3-65" data-line-number="65"></a>
<a class="sourceLine" id="cb3-66" data-line-number="66"><span class="ot">addSCC ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s (<span class="dt">Maybe</span> [<span class="dt">Int</span>])</a>
<a class="sourceLine" id="cb3-67" data-line-number="67">addSCC n v scc stack stackSet <span class="fu">=</span> pop stack stackSet <span class="fu">&gt;&gt;=</span> \w <span class="ot">-&gt;</span> <span class="kw">if</span> ((other n w) <span class="ot">`elem`</span> scc) <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span></a>
<a class="sourceLine" id="cb3-68" data-line-number="68">    <span class="kw">let</span> scc' <span class="fu">=</span> w<span class="fu">:</span>scc</a>
<a class="sourceLine" id="cb3-69" data-line-number="69">    <span class="kw">in</span> <span class="kw">if</span> w <span class="fu">==</span> v <span class="kw">then</span> return (<span class="dt">Just</span> scc') <span class="kw">else</span> addSCC n v scc' stack stackSet</a>
<a class="sourceLine" id="cb3-70" data-line-number="70"></a>
<a class="sourceLine" id="cb3-71" data-line-number="71"><span class="ot">push ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s ()</a>
<a class="sourceLine" id="cb3-72" data-line-number="72">push stack stackSet e <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-73" data-line-number="73">    modifySTRef' stack (e<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb3-74" data-line-number="74">    write stackSet e <span class="dt">True</span></a>
<a class="sourceLine" id="cb3-75" data-line-number="75"></a>
<a class="sourceLine" id="cb3-76" data-line-number="76"><span class="ot">pop ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb3-77" data-line-number="77">pop stack stackSet <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-78" data-line-number="78">    e <span class="ot">&lt;-</span> head <span class="fu">&lt;$&gt;</span> readSTRef stack</a>
<a class="sourceLine" id="cb3-79" data-line-number="79">    modifySTRef' stack tail</a>
<a class="sourceLine" id="cb3-80" data-line-number="80">    write stackSet e <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-81" data-line-number="81">    return e</a>
<a class="sourceLine" id="cb3-82" data-line-number="82"></a>
<a class="sourceLine" id="cb3-83" data-line-number="83">denormalise     <span class="fu">=</span> subtract</a>
<a class="sourceLine" id="cb3-84" data-line-number="84">normalise       <span class="fu">=</span> (<span class="fu">+</span>)</a>
<a class="sourceLine" id="cb3-85" data-line-number="85">other n v       <span class="fu">=</span> <span class="dv">2</span><span class="fu">*</span>n <span class="fu">-</span> v</a>
<a class="sourceLine" id="cb3-86" data-line-number="86">clauses n [u,v] <span class="fu">=</span> [(other n u, v), (other n v, u)]</a>
<a class="sourceLine" id="cb3-87" data-line-number="87"></a>
<a class="sourceLine" id="cb3-88" data-line-number="88"><span class="ot">checkSat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb3-89" data-line-number="89">checkSat name <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-90" data-line-number="90">    p <span class="ot">&lt;-</span> map (map P.read <span class="fu">.</span> words) <span class="fu">.</span> lines <span class="fu">&lt;$&gt;</span> readFile name</a>
<a class="sourceLine" id="cb3-91" data-line-number="91">    <span class="kw">let</span> pNo    <span class="fu">=</span> head <span class="fu">$</span> head p</a>
<a class="sourceLine" id="cb3-92" data-line-number="92">        pn     <span class="fu">=</span> map (map (normalise pNo)) <span class="fu">$</span> tail p</a>
<a class="sourceLine" id="cb3-93" data-line-number="93">        pGraph <span class="fu">=</span> G.buildG (<span class="dv">0</span>,<span class="dv">2</span><span class="fu">*</span>pNo) <span class="fu">$</span> concatMap (clauses pNo) pn</a>
<a class="sourceLine" id="cb3-94" data-line-number="94">    return <span class="fu">$</span> (<span class="dt">Nothing</span> <span class="fu">/=</span>) <span class="fu">$</span> tarjan pNo pGraph</a></code></pre></div>
</details>
<details>
<p><summary>2SAT.hs using <code>whenM</code></summary></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Graph</span> <span class="kw">as</span> <span class="dt">G</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Array</span> <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span>    <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (lookup, read, replicate)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Monad.ST</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.STRef</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Control.Monad</span>       (forM_)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Vector.Mutable</span> (<span class="dt">STVector</span>, read, replicate, write)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="ot">whenM ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m <span class="dt">Bool</span> <span class="ot">-&gt;</span> m () <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">whenM condM block <span class="fu">=</span> condM <span class="fu">&gt;&gt;=</span> \cond <span class="ot">-&gt;</span> <span class="kw">if</span> cond <span class="kw">then</span> block <span class="kw">else</span> return ()</a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="ot">tarjan ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">G.Graph</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [[<span class="dt">Int</span>]]</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">tarjan n graph <span class="fu">=</span> runST <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">    index    <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    stack    <span class="ot">&lt;-</span> newSTRef []</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">    stackSet <span class="ot">&lt;-</span> replicate size <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">    indices  <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    lowlinks <span class="ot">&lt;-</span> replicate size <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    output   <span class="ot">&lt;-</span> newSTRef (<span class="dt">Just</span> [])</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">    forM_ (G.vertices graph) <span class="fu">$</span> \v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27">        whenM ((<span class="fu">==</span>) <span class="dt">Nothing</span> <span class="fu">&lt;$&gt;</span> read indices v) <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">            strongConnect n v graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb4-29" data-line-number="29"></a>
<a class="sourceLine" id="cb4-30" data-line-number="30">    readSTRef output</a>
<a class="sourceLine" id="cb4-31" data-line-number="31">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32">        size <span class="fu">=</span> snd (A.bounds graph) <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"></a>
<a class="sourceLine" id="cb4-34" data-line-number="34">strongConnect</a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="ot">    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36">    <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37">    <span class="ot">-&gt;</span> <span class="dt">G.Graph</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb4-40" data-line-number="40">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb4-42" data-line-number="42">    <span class="ot">-&gt;</span> <span class="dt">STVector</span> s (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb4-43" data-line-number="43">    <span class="ot">-&gt;</span> <span class="dt">STRef</span> s (<span class="dt">Maybe</span> [[<span class="dt">Int</span>]])</a>
<a class="sourceLine" id="cb4-44" data-line-number="44">    <span class="ot">-&gt;</span> <span class="dt">ST</span>    s ()</a>
<a class="sourceLine" id="cb4-45" data-line-number="45">strongConnect n v graph index stack stackSet indices lowlinks output <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-46" data-line-number="46">    i <span class="ot">&lt;-</span> readSTRef index</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">    write indices  v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb4-48" data-line-number="48">    write lowlinks v (<span class="dt">Just</span> i)</a>
<a class="sourceLine" id="cb4-49" data-line-number="49">    modifySTRef' index (<span class="fu">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-50" data-line-number="50">    push stack stackSet v</a>
<a class="sourceLine" id="cb4-51" data-line-number="51"></a>
<a class="sourceLine" id="cb4-52" data-line-number="52">    forM_ (graph <span class="fu">A.!</span> v) <span class="fu">$</span> \w <span class="ot">-&gt;</span> read indices w <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb4-53" data-line-number="53">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-54" data-line-number="54">            strongConnect n w graph index stack stackSet indices lowlinks output</a>
<a class="sourceLine" id="cb4-55" data-line-number="55">            write lowlinks v <span class="fu">=&lt;&lt;</span> (min <span class="fu">&lt;$&gt;</span> read lowlinks v <span class="fu">&lt;*&gt;</span> read lowlinks w)</a>
<a class="sourceLine" id="cb4-56" data-line-number="56">        <span class="dt">Just</span>{}  <span class="ot">-&gt;</span> whenM (read stackSet w) <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-57" data-line-number="57">            write lowlinks v <span class="fu">=&lt;&lt;</span> (min <span class="fu">&lt;$&gt;</span> read lowlinks v <span class="fu">&lt;*&gt;</span> read indices  w)</a>
<a class="sourceLine" id="cb4-58" data-line-number="58"></a>
<a class="sourceLine" id="cb4-59" data-line-number="59">    whenM ((<span class="fu">==</span>) <span class="fu">&lt;$&gt;</span> read lowlinks v <span class="fu">&lt;*&gt;</span> read indices v) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-60" data-line-number="60">        scc <span class="ot">&lt;-</span> addSCC n v [] stack stackSet</a>
<a class="sourceLine" id="cb4-61" data-line-number="61">        modifySTRef' output <span class="fu">$</span> \sccs <span class="ot">-&gt;</span> (<span class="fu">:</span>) <span class="fu">&lt;$&gt;</span> scc <span class="fu">&lt;*&gt;</span> sccs</a>
<a class="sourceLine" id="cb4-62" data-line-number="62"></a>
<a class="sourceLine" id="cb4-63" data-line-number="63"><span class="ot">addSCC ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s (<span class="dt">Maybe</span> [<span class="dt">Int</span>])</a>
<a class="sourceLine" id="cb4-64" data-line-number="64">addSCC n v scc stack stackSet <span class="fu">=</span> pop stack stackSet <span class="fu">&gt;&gt;=</span> \w <span class="ot">-&gt;</span> <span class="kw">if</span> ((other n w) <span class="ot">`elem`</span> scc) <span class="kw">then</span> return <span class="dt">Nothing</span> <span class="kw">else</span></a>
<a class="sourceLine" id="cb4-65" data-line-number="65">    <span class="kw">let</span> scc' <span class="fu">=</span> w<span class="fu">:</span>scc</a>
<a class="sourceLine" id="cb4-66" data-line-number="66">    <span class="kw">in</span> <span class="kw">if</span> w <span class="fu">==</span> v <span class="kw">then</span> return (<span class="dt">Just</span> scc') <span class="kw">else</span> addSCC n v scc' stack stackSet</a>
<a class="sourceLine" id="cb4-67" data-line-number="67"></a>
<a class="sourceLine" id="cb4-68" data-line-number="68"><span class="ot">push ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s ()</a>
<a class="sourceLine" id="cb4-69" data-line-number="69">push stack stackSet e <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-70" data-line-number="70">    modifySTRef' stack (e<span class="fu">:</span>)</a>
<a class="sourceLine" id="cb4-71" data-line-number="71">    write stackSet e <span class="dt">True</span></a>
<a class="sourceLine" id="cb4-72" data-line-number="72"></a>
<a class="sourceLine" id="cb4-73" data-line-number="73"><span class="ot">pop ::</span> <span class="dt">STRef</span> s [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">STVector</span> s <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ST</span> s <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-74" data-line-number="74">pop stack stackSet <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-75" data-line-number="75">    e <span class="ot">&lt;-</span> head <span class="fu">&lt;$&gt;</span> readSTRef stack</a>
<a class="sourceLine" id="cb4-76" data-line-number="76">    modifySTRef' stack tail</a>
<a class="sourceLine" id="cb4-77" data-line-number="77">    write stackSet e <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-78" data-line-number="78">    return e</a>
<a class="sourceLine" id="cb4-79" data-line-number="79"></a>
<a class="sourceLine" id="cb4-80" data-line-number="80">denormalise     <span class="fu">=</span> subtract</a>
<a class="sourceLine" id="cb4-81" data-line-number="81">normalise       <span class="fu">=</span> (<span class="fu">+</span>)</a>
<a class="sourceLine" id="cb4-82" data-line-number="82">other n v       <span class="fu">=</span> <span class="dv">2</span><span class="fu">*</span>n <span class="fu">-</span> v</a>
<a class="sourceLine" id="cb4-83" data-line-number="83">clauses n [u,v] <span class="fu">=</span> [(other n u, v), (other n v, u)]</a>
<a class="sourceLine" id="cb4-84" data-line-number="84"></a>
<a class="sourceLine" id="cb4-85" data-line-number="85"><span class="ot">checkSat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb4-86" data-line-number="86">checkSat name <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-87" data-line-number="87">    p <span class="ot">&lt;-</span> map (map P.read <span class="fu">.</span> words) <span class="fu">.</span> lines <span class="fu">&lt;$&gt;</span> readFile name</a>
<a class="sourceLine" id="cb4-88" data-line-number="88">    <span class="kw">let</span> pNo    <span class="fu">=</span> head <span class="fu">$</span> head p</a>
<a class="sourceLine" id="cb4-89" data-line-number="89">        pn     <span class="fu">=</span> map (map (normalise pNo)) <span class="fu">$</span> tail p</a>
<a class="sourceLine" id="cb4-90" data-line-number="90">        pGraph <span class="fu">=</span> G.buildG (<span class="dv">0</span>,<span class="dv">2</span><span class="fu">*</span>pNo) <span class="fu">$</span> concatMap (clauses pNo) pn</a>
<a class="sourceLine" id="cb4-91" data-line-number="91">    return <span class="fu">$</span> (<span class="dt">Nothing</span> <span class="fu">/=</span>) <span class="fu">$</span> tarjan pNo pGraph</a></code></pre></div>
</details>

        </div>
        <div id="footer">
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
    </body>
</html>
