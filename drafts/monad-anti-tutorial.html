<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Monad Anti-tutorial</title>
        <link rel="stylesheet" href="http://www.vaibhavsagar.com/theme/css/main.css" />
        <link href="http://www.vaibhavsagar.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Vaibhav Sagar's Site Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="https://github.com/vaibhavsagar">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://www.vaibhavsagar.com/">Vaibhav Sagar's Site </a></h1>
                <nav><ul>
                    <li><a href="/blog/archives/">all</a></li>
                    <li><a href="http://www.vaibhavsagar.com/about/">about</a></li>
                    <li><a href="http://www.vaibhavsagar.com/blog/misc/">misc</a></li>
                    <li class="active"><a href="http://www.vaibhavsagar.com/blog/programming/">programming</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://www.vaibhavsagar.com/drafts/monad-anti-tutorial.html" rel="bookmark"
           title="Permalink to Monad Anti-tutorial">Monad Anti-tutorial</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-08T00:00:00+11:00">
                Published: Sat 08 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.vaibhavsagar.com/author/vaibhav-sagar.html">Vaibhav Sagar</a>
        </address>
<p>In <a href="http://www.vaibhavsagar.com/blog/programming/">programming</a>.</p>

</footer><!-- /.post-info -->      <p>Like so many before me, I feel the primal urge to inflict yet another (Haskell)
monad tutorial on an innocent and unsuspecting universe. For a host of reasons,
this is a bad idea. One reason is that I'm not going to do a better job of
explaining monads than everyone else. However, I probably am better at not
explaining monads, which is why you get an anti-tutorial where I don't even
try. I might try to explain some other stuff, but I make no promises.</p>
<p>What is a monad (in Haskell)? <code>Monad</code> is a typeclass , which is very much like
an interface in many other languages. Because Haskell is not object-oriented,
it has types conform to interfaces instead of objects (which it doesn't have),
and each type can declare that it implements a particular typeclass. This
involves supplying definitions for each function that the typeclass specifies.
<code>Monad</code> looks very much like this:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="kr">where</span>
    <span class="n">return</span> <span class="ow">::</span> <span class="n">a</span>   <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
    <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span>  <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
</pre></div>


<p>There are two things I think are confusing about this definition:</p>
<ol>
<li>
<p><code>return</code> is a regular function whose meaning is unrelated to the <code>return</code>
   statement in most other programming languages.</p>
</li>
<li>
<p>Haskell allows you to define infix operators by surrounding them in
   parentheses, and this one looks a bit odd and vaguely threatening.</p>
</li>
</ol>
<p>There are some laws that well-behaved implementations are supposed to observe:</p>
<div class="highlight"><pre><span></span><span class="nf">return</span> <span class="n">a</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span>           <span class="ow">=</span>  <span class="n">f</span> <span class="n">a</span>
<span class="nf">m</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span>             <span class="ow">=</span>  <span class="n">m</span>
<span class="nf">m</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">g</span><span class="p">)</span>  <span class="ow">=</span>  <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">g</span>
</pre></div>


<p>I won't explain these, but I will point them out.</p>
<p>And that's all. Really.</p>
<p>So what's all the hype about?</p>
<p>Haskell has syntax sugar for this particular typeclass, which is probably one
reason. This syntax sugar is known as <code>do</code>-notation. It allows you to write
code that looks like</p>
<div class="highlight"><pre><span></span><span class="nf">foo</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a&#39;</span> <span class="ow">&lt;-</span> <span class="n">a</span>
    <span class="n">b&#39;</span> <span class="ow">&lt;-</span> <span class="n">b</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a&#39;</span> <span class="o">+</span> <span class="n">b&#39;</span><span class="p">)</span>
</pre></div>


<p>that then gets rewritten to</p>
<div class="highlight"><pre><span></span><span class="nf">foo</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="n">a</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">a&#39;</span> <span class="ow">-&gt;</span>
    <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">b&#39;</span> <span class="ow">-&gt;</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a&#39;</span> <span class="o">+</span> <span class="n">b&#39;</span><span class="p">)</span>
</pre></div>


<p>If you want to define variables in between you can use</p>
<div class="highlight"><pre><span></span><span class="nf">bar</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a&#39;</span> <span class="ow">&lt;-</span> <span class="n">a</span>
    <span class="kr">let</span> <span class="n">a&#39;&#39;</span> <span class="ow">=</span> <span class="n">a&#39;</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">b&#39;</span> <span class="ow">&lt;-</span> <span class="n">b</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a&#39;&#39;</span> <span class="o">+</span> <span class="n">b&#39;</span><span class="p">)</span>
</pre></div>


<p>and this becomes</p>
<div class="highlight"><pre><span></span><span class="nf">bar</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="n">a</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">a&#39;</span> <span class="ow">-&gt;</span>
    <span class="kr">let</span> <span class="n">a&#39;&#39;</span> <span class="ow">=</span> <span class="n">a&#39;</span> <span class="o">+</span> <span class="mi">1</span> <span class="kr">in</span>
    <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">b&#39;</span> <span class="ow">-&gt;</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a&#39;&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</pre></div>


<p>and if you don't care about the variable on the left hand side of the <code>&lt;-</code>, you
can omit it like</p>
<div class="highlight"><pre><span></span><span class="nf">baz</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a</span>
    <span class="n">b&#39;</span> <span class="ow">&lt;-</span> <span class="n">b</span>
    <span class="n">return</span> <span class="n">b&#39;</span>
</pre></div>


<p>which desugars to</p>
<div class="highlight"><pre><span></span><span class="nf">baz</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="n">a</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="kr">_</span>  <span class="ow">-&gt;</span>
    <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">b&#39;</span> <span class="ow">-&gt;</span>
    <span class="n">return</span> <span class="n">b&#39;</span>
</pre></div>


<p>I think it's worth spending time on understanding <code>do</code> notation and converting
between the sugared and desugared representations because:</p>
<ol>
<li>
<p>Familiarity with <code>do</code> notation will allow you to effectively use monads,
   whether or not you feel you understand them.</p>
</li>
<li>
<p>Doing this will teach you (or at least help you learn) the monad laws.</p>
</li>
</ol>
<p>But enough about that. Let's walk through some contrived examples to see how
this works in practice!</p>
<p>I'd like to start with the <code>Maybe</code> type, which allows us to work with possibly
<code>null</code> values in a way I think is better than most other approaches. The
implementation (or <code>instance</code>) of <code>Monad</code> looks like</p>
<div class="highlight"><pre><span></span><span class="kr">instance</span> <span class="kt">Monad</span> <span class="kt">Maybe</span> <span class="kr">where</span>
    <span class="n">return</span> <span class="n">v</span>         <span class="ow">=</span> <span class="kt">Just</span> <span class="n">v</span>
    <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span> <span class="kt">Nothing</span>  <span class="kr">_</span> <span class="ow">=</span> <span class="kt">Nothing</span>
    <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">v</span><span class="p">)</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">f</span> <span class="n">v</span>
</pre></div>


<p>and in use it looks like</p>
<div class="highlight"><pre><span></span><span class="nf">λ</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">Just</span> <span class="mi">3</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">Nothing</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">1</span><span class="p">)</span> <span class="kt">Nothing</span>
<span class="kt">Nothing</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">bar</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">Just</span> <span class="mi">4</span>
</pre></div>


<p>This captures the idea that if any of the parameters is <code>Nothing</code>, the overall
result should also be <code>Nothing</code>. The cool part is that we don't need to worry
about this when defining <code>f</code>, because the underlying implementation takes care
of it for us.</p>
<p>A second example is the <code>List</code> type. A valid instance looks like</p>
<div class="highlight"><pre><span></span><span class="kr">instance</span> <span class="kt">Monad</span> <span class="kt">[]</span> <span class="kr">where</span>
    <span class="n">return</span> <span class="n">v</span>   <span class="ow">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span>  <span class="n">v</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">concatMap</span> <span class="n">f</span> <span class="n">v</span>
</pre></div>


<p>and you would use this like</p>
<div class="highlight"><pre><span></span><span class="nf">λ</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="kt">[]</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="kt">[]</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">bar</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
</pre></div>


<p>Where a <code>Maybe</code> can be one of two possible values, a <code>List</code> is an arbitrary
number of values.</p>
<p>So far both examples have been a bit box-like, but monads are more general than
that. Let's look at the <code>Reader</code> type, which allows us to <code>ask</code> for some value
that can be passed in later (very much like a function):</p>
<div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">Reader</span> <span class="n">e</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Reader</span> <span class="p">{</span><span class="n">runReader</span> <span class="ow">::</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">a</span><span class="p">}</span>

<span class="nf">ask</span> <span class="ow">=</span> <span class="kt">Reader</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">e</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Monad</span> <span class="p">(</span><span class="kt">Reader</span> <span class="n">e</span><span class="p">)</span> <span class="kr">where</span>
   <span class="n">return</span> <span class="n">a</span>           <span class="ow">=</span> <span class="kt">Reader</span> <span class="p">(</span><span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">a</span><span class="p">)</span>
   <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span> <span class="p">(</span><span class="kt">Reader</span> <span class="n">r</span><span class="p">)</span> <span class="n">f</span> <span class="ow">=</span> <span class="kt">Reader</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">runReader</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">r</span> <span class="n">e</span><span class="p">))</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<p>This one is a bit more interesting to use.</p>
<div class="highlight"><pre><span></span><span class="nf">x</span> <span class="ow">=</span> <span class="kr">do</span>
   <span class="n">value</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
   <span class="n">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="nf">y</span> <span class="ow">=</span> <span class="kr">do</span>
   <span class="n">value</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
   <span class="n">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">runReader</span> <span class="p">(</span><span class="n">foo</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="mi">1</span>
<span class="mi">5</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">runReader</span> <span class="p">(</span><span class="n">foo</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="mi">2</span>
<span class="mi">7</span>
<span class="nf">λ</span><span class="o">&gt;</span> <span class="n">runReader</span> <span class="p">(</span><span class="n">bar</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="mi">1</span>
<span class="mi">6</span>
</pre></div>


<p>Finally, let's look at the <code>IO</code> type, which I find a bit scary. I don't really
understand how it's implemented. so I'll be skipping that section. Fortunately,
we know how to use it, because we know the interface, so let's do that.</p>
<div class="highlight"><pre><span></span>getInt <span class="o">=</span> do
   input <span class="o">&lt;-</span> baz <span class="p">(</span>putStr <span class="s">&quot;Enter integer: &quot;</span><span class="p">)</span> getLine
   let int <span class="o">=</span> read input <span class="o">::</span> Int
   <span class="kr">return</span> int

λ<span class="o">&gt;</span> foo getInt getInt
Enter <span class="kt">integer</span><span class="o">:</span> <span class="m">1</span>
Enter <span class="kt">integer</span><span class="o">:</span> <span class="m">2</span>
<span class="m">3</span>
λ<span class="o">&gt;</span> bar getInt getInt
Enter <span class="kt">integer</span><span class="o">:</span> <span class="m">1</span>
Enter <span class="kt">integer</span><span class="o">:</span> <span class="m">2</span>
<span class="m">4</span>
</pre></div>


<p>Okay, enough examples. As you can see, we've used the same interface to work
deal with failure, an arbitrary number of values, an extra parameter, and
input/output. There are many useful monad instances in Haskell, from container
types such as Set and Map to abstractions such as Writer and State, through to
control flow as implemented by the Cont monad.</p>
<p>I don't think the answer to the question "what is a monad?" is as useful as
learning the mechanics of working with them, even ones you don't fully
understand. If you can make your type conform to the typeclass, Haskell will
give you a pretty general and flexible API to work with it. As far as I'm
concerned, this is the point of monads in Haskell.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://www.vaibhavsagar.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-79891461-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'vaibhavsagar';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>