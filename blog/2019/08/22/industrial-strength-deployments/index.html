<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Industrial-strength Deployments in Three Commands - Vaibhav Sagar</title>
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-79891461-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Industrial-strength Deployments in Three Commands</h1>

            <div class="info">
    Posted on 22 August 2019
    
</div>
<div class="info">
    
        Tags: <a href="../../../../../blog/tags/nix/">nix</a>, <a href="../../../../../blog/tags/programming/">programming</a>
    
</div>

<p>If your deployment target is running NixOS, a full-system deployment is only three commands:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">$ <span class="ex">nix-copy-closure</span> --to --use-substitutes <span class="op">&lt;</span>target<span class="op">&gt;</span> <span class="op">&lt;</span>path<span class="op">&gt;</span>                                <span class="co">#1</span></a>
<a class="sourceLine" id="cb1-2" title="2">$ <span class="fu">ssh</span> <span class="op">&lt;</span>target<span class="op">&gt;</span> -- <span class="st">&quot;sudo nix-env --profile /nix/var/nix/profiles/system --set &lt;path&gt;&quot;</span>     <span class="co">#2</span></a>
<a class="sourceLine" id="cb1-3" title="3">$ <span class="fu">ssh</span> <span class="op">&lt;</span>target<span class="op">&gt;</span> -- <span class="st">&quot;sudo /nix/var/nix/profiles/system/bin/switch-to-configuration switch&quot;</span> <span class="co">#3</span></a></code></pre></div>
<p>Here’s what each command does:</p>
<ol type="1">
<li>Copies the transitive closure of the new system configuration to the target, using binary caches (<code>--use-substitutes</code>) where possible.</li>
<li>Sets the current system profile to the new system configuration. This isn’t strictly necessary, but allows us to roll back to this configuration later.</li>
<li>Switches to the new system configuration.</li>
</ol>
<p>This workflow has been described before <a href="https://typeclasses.com/nixos-on-aws">in Typeclasses</a> and <a href="http://www.haskellforall.com/2018/08/nixos-in-production.html">by Gabriel Gonzalez</a>, but I thought one more post demonstrating how to use these commands wouldn’t hurt. Since the AWS use case has been covered so thoroughly by Typeclasses, I’m going to use the <a href="https://www.packet.com/">packet.net</a> cloud instead.</p>
<h4 id="provisioning">Provisioning</h4>
<p>I logged on to the Packet console and launched a <code>t1.small.x86</code> instance running NixOS 19.03 (the latest as of this writing). It was assigned the IP address <code>147.75.38.113</code>. Since I added my SSH keys when I first created my Packet account, I was able to SSH into this instance at <code>root@147.75.38.113</code> without any further configuration.</p>
<h4 id="copying-the-existing-configuration">Copying the existing configuration</h4>
<p>The next step is to copy the existing configuration, especially instance-specific hardware configuration:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="fu">scp</span> -r root@147.75.38.113:/etc/nixos/* .</a></code></pre></div>
<p>There’s probably a better way to do this, but for a quick one-off demonstration this is fine. <a href="https://github.com/vaibhavsagar/nixos-config/commit/e49e9a980f2d547684bcab3a34a34dba4521b991">Here’s the commit adding those files</a>.</p>
<p>We’ll only be making changes to <code>configuration.nix</code>, which for me looks like this (after all commented-out lines have been removed):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">{</span> <span class="ex">config</span>, pkgs, ... <span class="kw">}</span>:</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="ex">imports</span> =</a>
<a class="sourceLine" id="cb3-5" title="5">    [</a>
<a class="sourceLine" id="cb3-6" title="6">      <span class="ex">./packet.nix</span></a>
<a class="sourceLine" id="cb3-7" title="7">    ];</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="ex">boot.loader.grub.enable</span> = true<span class="kw">;</span></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="ex">boot.loader.grub.version</span> = 2<span class="kw">;</span></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12">  <span class="ex">system.stateVersion</span> = <span class="st">&quot;19.03&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb3-13" title="13"></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="kw">}</span></a></code></pre></div>
<h4 id="building-a-system-closure">Building a system closure</h4>
<p>The Nix expression to build a whole system is pretty straightforward (as described in the Typeclasses article):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="bu">let</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="ex">nixos</span> = import <span class="op">&lt;</span>nixpkgs/nixos<span class="op">&gt;</span> {</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="ex">configuration</span> = import ./configuration.nix<span class="kw">;</span></a>
<a class="sourceLine" id="cb4-4" title="4">  };</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">in</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="ex">nixos.system</span></a></code></pre></div>
<p>but this doesn’t provide any way of pinning <code>nixpkgs</code>. Another way (<a href="http://www.haskellforall.com/2018/08/nixos-in-production.html#pinning-nixpkgs">as described by Gabriel Gonzalez</a>), is to explicitly depend on a particular revision of <code>nixpkgs</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="bu">let</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="ex">nixpkgs</span> = builtins.fetchTarball {</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="ex">url</span> = <span class="st">&quot;https://github.com/NixOS/nixpkgs/archive/b74b1cdb2fecc31ff7a127c5bc89771f887c93bb.tar.gz&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="ex">sha256</span> = <span class="st">&quot;0ncr4g29220amqm4riaa1xf4jz55v2nmh9fi16f1gzhww1gplk8h&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">  };</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">in</span></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="ex">import</span> <span class="st">&quot;</span><span class="va">${nixpkgs}</span><span class="st">/nixos&quot;</span> {</a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="ex">configuration</span> = {</a>
<a class="sourceLine" id="cb5-10" title="10">      <span class="ex">imports</span> = [</a>
<a class="sourceLine" id="cb5-11" title="11">        <span class="ex">/etc/nixos/configuration.nix</span></a>
<a class="sourceLine" id="cb5-12" title="12">      ];</a>
<a class="sourceLine" id="cb5-13" title="13">    };</a>
<a class="sourceLine" id="cb5-14" title="14"></a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="ex">system</span> = <span class="st">&quot;x86_64-linux&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb5-16" title="16">  }</a></code></pre></div>
<p>but the downside there is that there’s no automated way to update the revision of <code>nixpkgs</code>. I have <a href="https://vaibhavsagar.com/blog/2018/05/27/quick-easy-nixpkgs-pinning/">my own approach to pinning <code>nixpkgs</code></a>, where I have a <code>versions.json</code> that stores version information:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">&quot;nixpkgs&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">&quot;owner&quot;</span><span class="fu">:</span> <span class="st">&quot;NixOS&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="dt">&quot;repo&quot;</span><span class="fu">:</span> <span class="st">&quot;nixpkgs-channels&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="dt">&quot;branch&quot;</span><span class="fu">:</span> <span class="st">&quot;nixos-19.03&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="dt">&quot;rev&quot;</span><span class="fu">:</span> <span class="st">&quot;77295b0bd26555c39a1ba9c1da72dbdb651fd280&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="dt">&quot;sha256&quot;</span><span class="fu">:</span> <span class="st">&quot;18v866h12xk6l1s37nk1vns869pvzphmnnlhrnm2b1zklg2hd1nq&quot;</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="fu">}</span></a></code></pre></div>
<p>and a script that uses <code>jq</code> to update this file. My (slightly more complex) expression then looks like this:</p>
<p><em>default.nix</em></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="bu">let</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="ex">fetcher</span> = { owner, repo, rev, sha256, ... }: <span class="ex">builtins.fetchTarball</span> {</a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="ex">inherit</span> sha256<span class="kw">;</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="ex">url</span> = <span class="st">&quot;https://github.com/</span><span class="va">${owner}</span><span class="st">/</span><span class="va">${repo}</span><span class="st">/tarball/</span><span class="va">${rev}</span><span class="st">&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb7-5" title="5">  };</a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="ex">nixpkgs</span> = fetcher (builtins.fromJSON (builtins.readFile ./versions.json))<span class="ex">.nixpkgs</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="ex">nixos</span> = import <span class="st">&quot;</span><span class="va">${nixpkgs}</span><span class="st">/nixos&quot;</span> {</a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="ex">configuration</span> = import ./configuration.nix<span class="kw">;</span></a>
<a class="sourceLine" id="cb7-9" title="9">  };</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="kw">in</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="ex">nixos.system</span></a></code></pre></div>
<p>and this allows me to both be explicit about <code>nixpkgs</code> as well as easily update it when necessary. <a href="https://github.com/vaibhavsagar/nixos-config/commit/5126d9dba971d6480aeec43c4263c5a7f7b1f1b5">Here’s the commit that adds those files</a>.</p>
<h4 id="deploying-the-system-closure">Deploying the system closure</h4>
<p>With all of our prerequisites taken care of, deploying the system closure is straightforward:</p>
<p><em>deploy.sh</em></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">set</span> <span class="ex">-euxo</span> pipefail</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="va">TARGET=</span><span class="st">&quot;root@147.75.38.113&quot;</span></a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="va">PROFILE_PATH=</span><span class="st">&quot;</span><span class="va">$(</span><span class="ex">nix-build</span> --no-out-link default.nix<span class="va">)</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="ex">nix-copy-closure</span> --to --use-substitutes <span class="va">$TARGET</span> <span class="va">$PROFILE_PATH</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="fu">ssh</span> <span class="va">$TARGET</span> -- <span class="st">&quot;nix-env --profile /nix/var/nix/profiles/system --set </span><span class="va">$PROFILE_PATH</span><span class="st"> &amp;&amp; /nix/var/nix/profiles/system/bin/switch-to-configuration switch&quot;</span></a></code></pre></div>
<p>This takes care of both building the new system closure and deploying it.</p>
<p><a href="https://github.com/vaibhavsagar/nixos-config/commit/be6aaa026c8ebf1efd7c44743a8770b921111a2e">Here’s the commit that adds <code>deploy.sh</code></a>.</p>
<h4 id="adding-a-service">Adding a service</h4>
<p>Let’s deploy the final version of the small Haskell web service from my <a href="https://vaibhavsagar.com/blog/2019/07/04/functional-devops/">Functional DevOps</a> post. The application consists of two files:</p>
<p><em>Main.hs</em></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"> <span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">import</span> <span class="dt">Web.Scotty</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs)</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="kw">import</span> <span class="dt">Data.Monoid</span> (mconcat)</a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8">main <span class="ot">=</span> getArgs <span class="op">&gt;&gt;=</span> \(port<span class="op">:</span>_) <span class="ot">-&gt;</span> scotty (<span class="fu">read</span> port) <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-9" title="9">    get <span class="st">&quot;/:word&quot;</span> <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-10" title="10">        beam <span class="ot">&lt;-</span> param <span class="st">&quot;word&quot;</span></a>
<a class="sourceLine" id="cb9-11" title="11">        html <span class="op">$</span> <span class="fu">mconcat</span> [<span class="st">&quot;&lt;h1&gt;Scotty, &quot;</span>, beam, <span class="st">&quot; me up!&lt;/h1&gt;&quot;</span>]</a></code></pre></div>
<p><em>blank-me-up.cabal</em></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode default"><code class="sourceCode default"><a class="sourceLine" id="cb10-1" title="1">name:                blank-me-up</a>
<a class="sourceLine" id="cb10-2" title="2">version:             0.1.0.0</a>
<a class="sourceLine" id="cb10-3" title="3">license:             BSD3</a>
<a class="sourceLine" id="cb10-4" title="4">build-type:          Simple</a>
<a class="sourceLine" id="cb10-5" title="5">cabal-version:       &gt;=1.10</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">executable blank-me-up</a>
<a class="sourceLine" id="cb10-8" title="8">  main-is:             Main.hs</a>
<a class="sourceLine" id="cb10-9" title="9">  build-depends:       base &gt;=4.9 &amp;&amp; &lt;5</a>
<a class="sourceLine" id="cb10-10" title="10">                     , scotty</a>
<a class="sourceLine" id="cb10-11" title="11">  default-language:    Haskell2010</a></code></pre></div>
<p>and the Nix service is one file:</p>
<p><em>service.nix</em></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">{</span> <span class="ex">config</span>, lib, pkgs, ... <span class="kw">}</span>:</a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="bu">let</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="ex">blank-me-up</span> = pkgs.haskellPackages.callCabal2nix <span class="st">&quot;blank-me-up&quot;</span> ../app {};</a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="ex">cfg</span> = config.services.blank-me-up<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="kw">in</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">  <span class="ex">options.services.blank-me-up.enable</span> = lib.mkEnableOption <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="ex">options.services.blank-me-up.port</span> = lib.mkOption {</a>
<a class="sourceLine" id="cb11-9" title="9">    <span class="ex">default</span> = 3000<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-10" title="10">    <span class="bu">type</span> = lib.types.int<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="kw">}</span>;</a>
<a class="sourceLine" id="cb11-12" title="12"></a>
<a class="sourceLine" id="cb11-13" title="13">  <span class="ex">config</span> = lib.mkIf cfg.enable {</a>
<a class="sourceLine" id="cb11-14" title="14">    <span class="ex">networking.firewall.allowedTCPPorts</span> = [ cfg.port ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-15" title="15"></a>
<a class="sourceLine" id="cb11-16" title="16">    <span class="ex">systemd.services.blank-me-up</span> = {</a>
<a class="sourceLine" id="cb11-17" title="17">      <span class="ex">description</span> = <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb11-18" title="18">      <span class="ex">after</span> = [ <span class="st">&quot;network.target&quot;</span> ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-19" title="19">      <span class="ex">wantedBy</span> = [ <span class="st">&quot;multi-user.target&quot;</span> ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb11-20" title="20">      <span class="ex">serviceConfig</span> = {</a>
<a class="sourceLine" id="cb11-21" title="21">        <span class="ex">ExecStart</span> = <span class="st">&quot;</span><span class="va">${blank-</span>me-up<span class="va">}</span><span class="st">/bin/blank-me-up </span><span class="va">${toString</span><span class="er"> cfg.port</span><span class="va">}</span><span class="st">&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb11-22" title="22">        <span class="ex">Restart</span> = <span class="st">&quot;always&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb11-23" title="23">        <span class="ex">KillMode</span> = <span class="st">&quot;process&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb11-24" title="24">      };</a>
<a class="sourceLine" id="cb11-25" title="25">    };</a>
<a class="sourceLine" id="cb11-26" title="26">  };</a>
<a class="sourceLine" id="cb11-27" title="27">}</a></code></pre></div>
<p>For more information about what’s happening in <code>service.nix</code>, see <a href="https://vaibhavsagar.com/blog/2019/07/04/functional-devops/#service-configuration">the relevant section of my Functional DevOps post</a>.</p>
<p><a href="https://github.com/vaibhavsagar/nixos-config/commit/466e0e1867e47346ed8cc706b812a8cb21c76c19">Here’s the commit that adds these files</a>.</p>
<p>Enabling the service is as easy as adding two lines to <code>configuration.nix</code>:</p>
<p><em>configuration.nix</em></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">{</span> <span class="ex">config</span>, pkgs, ... <span class="kw">}</span>:</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw">{</span></a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="ex">imports</span> =</a>
<a class="sourceLine" id="cb12-5" title="5">    [</a>
<a class="sourceLine" id="cb12-6" title="6">      <span class="ex">./packet.nix</span></a>
<a class="sourceLine" id="cb12-7" title="7">      <span class="ex">./deploy/nix/service.nix</span>        <span class="co">#1</span></a>
<a class="sourceLine" id="cb12-8" title="8">    ];</a>
<a class="sourceLine" id="cb12-9" title="9"></a>
<a class="sourceLine" id="cb12-10" title="10">  <span class="ex">boot.loader.grub.enable</span> = true<span class="kw">;</span></a>
<a class="sourceLine" id="cb12-11" title="11">  <span class="ex">boot.loader.grub.version</span> = 2<span class="kw">;</span></a>
<a class="sourceLine" id="cb12-12" title="12"></a>
<a class="sourceLine" id="cb12-13" title="13">  <span class="ex">services.blank-me-up.enable</span> = true<span class="kw">;</span> <span class="co">#2</span></a>
<a class="sourceLine" id="cb12-14" title="14"></a>
<a class="sourceLine" id="cb12-15" title="15">  <span class="ex">system.stateVersion</span> = <span class="st">&quot;19.03&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb12-16" title="16"></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="kw">}</span></a></code></pre></div>
<p><a href="https://github.com/vaibhavsagar/nixos-config/commit/07b163f3c0fe728078bb357841e57c7020bdd4d3">Here’s the commit that makes that change</a>.</p>
<h4 id="deploying-the-service">Deploying the service</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1">$ <span class="ex">./deploy.sh</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="ex">+</span> TARGET=root@147.75.38.113</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="ex">++</span> nix-build --no-out-link default.nix</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="ex">+</span> PROFILE_PATH=/nix/store/<span class="op">&lt;</span>hash<span class="op">&gt;</span>-nixos-system-nixos-19.03pre-git</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="ex">+</span> nix-copy-closure --to --use-substitutes root@147.75.38.113 /nix/store/<span class="op">&lt;</span>hash<span class="op">&gt;</span>-nixos-system-nixos-19.03pre-git</a>
<a class="sourceLine" id="cb13-6" title="6"><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="ex">+</span> ssh root@147.75.38.113 -- <span class="st">'nix-env --profile /nix/var/nix/profiles/system --set /nix/store/&lt;hash&gt;-nixos-system-nixos-19.03pre-git &amp;&amp; /nix/var/nix/profiles/system/bin/switch-to-configuration switch'</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="ex">updating</span> GRUB 2 menu...</a>
<a class="sourceLine" id="cb13-9" title="9"><span class="ex">activating</span> the configuration...</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="ex">setting</span> up /etc...</a>
<a class="sourceLine" id="cb13-11" title="11"><span class="ex">reloading</span> user units for root...</a>
<a class="sourceLine" id="cb13-12" title="12"><span class="ex">setting</span> up tmpfiles</a>
<a class="sourceLine" id="cb13-13" title="13"></a>
<a class="sourceLine" id="cb13-14" title="14">$ <span class="ex">curl</span> http://147.75.38.113:3000/beam</a>
<a class="sourceLine" id="cb13-15" title="15"><span class="op">&lt;</span><span class="ex">h1</span><span class="op">&gt;</span>Scotty, beam me up!<span class="op">&lt;</span>/h1<span class="op">&gt;</span></a></code></pre></div>
<h4 id="but-this-is-just-a-janky-bash-script">But this is just a janky bash script!!???</h4>
<p>It’s definitely the case that <code>deploy.sh</code> is short and unsophisticated, but the three commands it invokes are what’s really important here. Once you begin looking for them, you will find them everywhere, since they’re the best way of deploying to NixOS! They’re used in <a href="https://github.com/NixOS/nixops/blob/c8d3a3ff5fb20e8e4d494de972ebb2a1a1ec1e08/nixops/backends/__init__.py#L339-L367">NixOps</a>, <a href="https://github.com/awakesecurity/nix-deploy/blob/68217cea7ba6746c9a262ddccb11178909841988/src/Main.hs#L159-L229">nix-deploy</a>, and <a href="https://github.com/obsidiansystems/obelisk/blob/1f9f466fc38a37a72afb316cee4f3317af204220/lib/command/src/Obelisk/Command/Deploy.hs#L136-L158">obelisk</a>, and a quick GitHub search for <a href="https://github.com/search?q=switch-to-configuration&amp;type=Code">“switch-to-configuration”</a> turns up many more examples. At a previous job, our deployment platform used these three commands as well, and we routinely deployed to hundreds of servers without any deployment-related issues, so I’m comfortable saying that this is an industrial-grade deployment solution.</p>
<h4 id="what-about-provisioning">What about provisioning?</h4>
<p>These tools don’t care how you provision your servers, as long as you end up with NixOS targets you can SSH into. For quick demonstrations and small deployments, manual provisioning is fine, but for anything beyond that, I’d recommend using a tool like <a href="https://www.terraform.io/">Terraform</a>. You can even specify your Terraform configuration with Nix using something like <a href="https://github.com/mrVanDalo/terranix">terranix</a>, and this is in fact what we did at the previous job I mentioned earlier, since Nix makes a great templating language and comes with excellent support for producing JSON which can then be fed into Terraform. It’s also possible to output YAML from Nix, which means it’s easy to interoperate with most infrastructure tooling.</p>
<h4 id="should-i-use-this-instead-of-my-current-deployment-solution">Should I use this instead of my current deployment solution?</h4>
<p>My aim with this post is not to convince you to drop whatever you’re currently using in favour of a hand-rolled bash script and NixOS, especially if your current solution works well for you. I do, however, want to encourage you to think about how the process I’ve outlined here compares. In which ways is it better or worse?</p>
<p>Since this is the workflow I’ve had the most experience with, it was a rude shock to start working with container-based deployments where even tiny changes require a full (slow) rebuild, and the actual deployment lifecycle is more complex and error-prone. I think it’s important to point out that things don’t have to be this way.</p>
<p>In my <a href="https://vaibhavsagar.com/blog/2019/07/04/functional-devops/">Functional DevOps</a> post, I outlined some characteristics of an ideal DevOps workflow, and I think the process I’ve outlined here meets them all:</p>
<ul>
<li><strong>Automatic</strong>: The process is completely scriptable.</li>
<li><strong>Repeatable</strong>: I can leverage NixOS to get the same results every time.</li>
<li><strong>Idempotent</strong>: Deploying the same thing a second time is a no-op.</li>
<li><strong>Reversible</strong>: Rolling back is very easy.</li>
<li><strong>Atomic</strong>: A deploy either fails or succeeds, there’s no weird in-between<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</li>
</ul>
<p>I think this is pretty great for three commands. I hope this blog post can help move us towards better systems by making this corner of NixOS more approachable!</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>As <a href="https://www.reddit.com/r/NixOS/comments/ctx8ii/industrialstrength_deployments_in_three_commands/expfqpv">ElvishJerricco points out on Reddit</a>, this isn’t quite true in the case of broken services.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩</a></p></li>
</ol>
</section>

        </div>
        <div id="footer">
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script>
            (function() {
	        if (window.location.hostname.indexOf('localhost') > -1) {
                        return;
                }

                var script = document.createElement('script');
                window.counter = 'https://vaibhavsagar.goatcounter.com/count'
                script.async = 1;
                script.src = '//static.goatcounter.com/count.min.js';

                var ins = document.getElementsByTagName('script')[0];
                ins.parentNode.insertBefore(script, ins)
            })();
        </script>
    </body>
</html>
